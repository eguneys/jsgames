<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://fonts.googleapis.com/css?family=Noto+Sans" rel="stylesheet">

  <link rel="manifest" href="site.webmanifest">
  <link rel="apple-touch-icon" href="icon.png">
  <!-- Place favicon.ico in the root directory -->

  <!-- <link rel="stylesheet" href="css/normalize.css"> -->
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/sokoban/index.css">
  <link rel="stylesheet" href="css/sokoban/theme.css">
  <link rel="stylesheet" href="assets/piece-css/pixel.css"/>

  <style>
   .sg-wrap {
       position: relative;
       margin: auto;
       width: 60%;
       height: 0;
       padding-bottom: 60%;
   }
   .controls {
       margin: auto;
   }
  </style>

  <script src="js/sokoban/bundle.js"></script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>otudated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->

  <!-- Add your site or application content here -->


  <section>
    <a href="https://github.com/eguneys/sokoground"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>


    <h1>Play Sokoban with AI</h1>

    <div id="app" class="is2d"></div>

    <div class="controls">
      <button id="nextLevel"> Next Level </button>
      <button id="prevLevel"> Previous Level </button>

      <input id="searchTime" type="range" min="100", max="1660000" value="1000"> Search Time </input>
    </div>

    <div class="hud">
      <p> <span> Level </span> <span id="level">?</span>
        <span> Status </span> <span id="isend"> ? </span> 
        <span> Legal moves </span>
        <span id="legals">?</span>
      </p>

      <p> Fen <span id="fen">?</span></p>
    </div>

    <div class="social">
      <a class="twitter-share-button"
         href="https://twitter.com/intent/tweet?text=Play Sokoban with AI!"
         data-size="large">
        Tweet</a>
    </div>
    <div class="information">
    </div>
  </section>

  <script>window.twttr = (function(d, s, id) {
     var js, fjs = d.getElementsByTagName(s)[0],
         t = window.twttr || {};
     if (d.getElementById(id)) return t;
     js = d.createElement(s);
     js.id = id;
     js.src = "https://platform.twitter.com/widgets.js";
     fjs.parentNode.insertBefore(js, fjs);

     t._e = [];
     t.ready = function(f) {
       t._e.push(f);
     };

     return t;
   }(document, "script", "twitter-wjs"));</script>


  <script>
   
   var sokoban;
   var level = 1;

   var opts = {
     events: {
       move() {
         renderHud(level, sokoban);
       }
     }
   };
   var kSearchTime = 200;

   function initAi(sokoban) {

     const initialFen = sokoban.getFen();
     const moves = [];
     function onBestMove(move) {
       sokoban.move(move);
       moves.push(move);
       setTimeout(reset, 0);
     }

     function reset() {
       var fen = sokoban.getFen();
       engine.stop();
       engine.setPosition(initialFen, moves);
       engine.go({
         searchDeadline: Date.now() + kSearchTime
       });
     }
     
     var engine = new Sokoban.Engine(onBestMove, {});

     reset();
   }

   Sokoban(document.getElementById('app'), opts, soko => {
     sokoban = soko;

     initAi(sokoban);

     renderHud(level, sokoban);
     onClick(document.getElementById('nextLevel'), () => {
       level++;
       renderHud(level, sokoban);
       sokoban.set({
         level: level
       });
     });

     onClick(document.getElementById('prevLevel'), () => {
       level--;
       renderHud(level, sokoban);
       sokoban.set({
         level: level
       });
     });

     document.getElementById('searchTime').oninput = function() {
       kSearchTime = parseInt(this.value);
     };
   });

   function renderHud(level, sokoban) {
     renderLevel(level);
     renderLegals(sokoban.getLegalMoves());
     renderFen(sokoban.getFen());
     renderIsEnd(sokoban.isEnd()?"is end": "is playing");
   }

   function renderIsEnd(str) {
     document.getElementById('isend').innerHTML = str;
   }

   function renderLegals(legals) {
     document.getElementById('legals').innerHTML = legals;
   }

   function renderFen(fen) {
     document.getElementById('fen').innerHTML = fen;
   }

   function renderLevel(level) {
     document.getElementById('level').innerHTML = level;
   }

   function onClick(el, f) {
     el.addEventListener('click', f);
   }
   

  </script>
  <!-- <script src="js/vendor/modernizr-{{MODERNIZR_VERSION}}.min.js"></script> -->
  <!-- <script src="https://code.jquery.com/jquery-{{JQUERY_VERSION}}.min.js" integrity="{{JQUERY_SRI_HASH}}" crossorigin="anonymous"></script> -->
  <!-- <script>window.jQuery || document.write('<script src="js/vendor/jquery-{{JQUERY_VERSION}}.min.js"><\/script>')</script> -->
  <!-- <script src="js/plugins.js"></script> -->
  <!-- <script src="js/main.js"></script> -->

  <!-- Google Analytics: change UA-XXXXX-Y to be your site's ID. -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-42906606-9', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>
</body>

</html>
