var kcapeW;(()=>{"use strict";var t={86:(t,e,i)=>{t.exports=i.p+"9680d0bd427f1b2ff56d.png"}},e={};function i(n){var r=e[n];if(void 0!==r)return r.exports;var o=e[n]={exports:{}};return t[n](o,o.exports,i),o.exports}i.d=(t,e)=>{for(var n in e)i.o(e,n)&&!i.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{var t;i.g.importScripts&&(t=i.g.location+"");var e=i.g.document;if(!t&&e&&(e.currentScript&&(t=e.currentScript.src),!t)){var n=e.getElementsByTagName("script");n.length&&(t=n[n.length-1].src)}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),i.p=t})();var n={};(()=>{i.r(n),i.d(n,{default:()=>W});var t=i(86);const e=function(){function t(t,e){this.ctx=t,this.image=e,this.ctx.imageSmoothingEnabled=!1}return t.prototype.cls=function(){this.ctx.clearRect(0,0,320,160)},t.prototype.camera=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),t=Math.floor(t),e=Math.floor(e),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.translate(t,e)},t.prototype.style=function(t){this.ctx.fillStyle=t},t.prototype.strokeStyle=function(t){this.ctx.strokeStyle=t},t.prototype.stroke=function(t,e,i,n){t=Math.floor(t),e=Math.floor(e),this.ctx.strokeRect(t,e,i,n)},t.prototype.rect=function(t,e,i,n){this.ctx.fillRect(t,e,i,n)},t.prototype.s=function(t,e,i,n,r,o,s,a,c){void 0===c&&(c=!1),r=Math.floor(r),o=Math.floor(o),this.ctx.save(),c&&(this.ctx.scale(-1,1),r*=-1,r-=s),this.ctx.drawImage(this.image,t,e,i,n,r,o,s,a),this.ctx.restore()},t}();var r;!function(t){t[t.Left=0]="Left",t[t.Right=1]="Right",t[t.Up=2]="Up",t[t.Down=3]="Down",t[t.X=4]="X",t[t.C=5]="C"}(r||(r={}));var o=[r.Left,r.Right,r.Up,r.Down,r.X,r.C];const s=function(){function t(){this.inputs={},this.gamepadPressed={}}return t.prototype.btn=function(t){var e;return(null===(e=this.inputs[t])||void 0===e?void 0:e.btn)||0},t.prototype.up=function(t){var e=this.inputs[t];e&&(e.btn=-10)},t.prototype.down=function(t){var e=this.inputs[t];e?e.btn>0||(e.btn=1):this.inputs[t]={btn:1}},t.prototype.update=function(){this.updateGamepad();for(var t=0,e=o;t<e.length;t++){var i=e[t],n=this.inputs[i];n&&0!==n.btn&&n.btn++}},t.prototype.bind=function(){var t=this;document.addEventListener("keyup",(function(e){switch(e.code){case"ArrowUp":t.up(r.Up);break;case"ArrowDown":t.up(r.Down);break;case"ArrowLeft":t.up(r.Left);break;case"ArrowRight":t.up(r.Right);break;case"KeyX":t.up(r.X);break;case"KeyC":t.up(r.C)}})),document.addEventListener("keydown",(function(e){switch(e.code){case"ArrowUp":t.down(r.Up);break;case"ArrowDown":t.down(r.Down);break;case"ArrowLeft":t.down(r.Left);break;case"ArrowRight":t.down(r.Right);break;case"KeyX":t.down(r.X);break;case"KeyC":t.down(r.C)}}))},t.prototype.upGamepad=function(t){this.gamepadPressed[t]&&(this.gamepadPressed[t]=!1,this.up(t))},t.prototype.downGamepad=function(t){this.gamepadPressed[t]||(this.gamepadPressed[t]=!0,this.down(t))},t.prototype.updateGamepad=function(){var t=navigator.getGamepads()[0];t&&(1===t.axes[0]?this.downGamepad(r.Right):-1===t.axes[0]?this.downGamepad(r.Left):(this.upGamepad(r.Left),this.upGamepad(r.Right)),1===t.axes[1]?this.downGamepad(r.Down):-1===t.axes[1]?this.downGamepad(r.Up):(this.upGamepad(r.Down),this.upGamepad(r.Up)),t.buttons[2].pressed?this.downGamepad(r.X):this.upGamepad(r.X),t.buttons[0].pressed?this.downGamepad(r.C):this.upGamepad(r.C))},t.prototype.bindGamepad=function(){window.addEventListener("gamepadconnected",(function(t){}))},t}(),a=function(t){var e=document.createElement("canvas");e.width=320,e.height=160;var i=e.getContext("2d");if(!i)throw"No 2d context";this.ctx=i,t.appendChild(e)};var c=function(t){this.context=t,this.draw=t.draw,this.input=t.input};function h(t,e,i){return e+(i-e)*t}const u=function(){function t(t,e){this.x=t,this.y=e}return Object.defineProperty(t.prototype,"i",{get:function(){return this.x},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"j",{get:function(){return this.y},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"key",{get:function(){return[this.x,this.y].join(" ")},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"neg",{get:function(){return this.scale(-1)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"half",{get:function(){return this.scale(.5)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"length",{get:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"normalize",{get:function(){return this.scale(1/this.length)},enumerable:!1,configurable:!0}),t.prototype.sub=function(t){return this.add(t.neg)},t.prototype.add=function(e){return new t(e.x+this.x,e.y+this.y)},t.prototype.scale=function(e){return this.mul(new t(e,e))},t.prototype.mul=function(e){return new t(e.x*this.x,e.y*this.y)},t.prototype.ipol=function(e,i){return new t(h(e,this.x,i.x),h(e,this.y,i.y))},t.zero=new t(0,0),t.one=new t(1,1),t.make=function(e,i){return new t(e,i)},t}();var p=u.make(8,8),f=u.make(320,160).half;const d=function(){function t(t,e,i,n){this.def={x:t,y:e,w:i,h:n}}return Object.defineProperty(t.prototype,"x",{get:function(){return this.def.x},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this.def.y},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"w",{get:function(){return this.def.w},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"h",{get:function(){return this.def.h},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"key",{get:function(){return(t=this.def).x+" "+t.y+" "+t.w+" "+t.h;var t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"top",{get:function(){return this.y},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"left",{get:function(){return this.x},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this.x+this.w},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bottom",{get:function(){return this.y+this.h},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"xy",{get:function(){return u.make(this.x,this.y)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"origin",{get:function(){return u.make(this.x+this.w/2,this.y+this.h/2)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"leftRect",{get:function(){return new t(this.x,this.y,this.w/2,this.h/2)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rightRect",{get:function(){return this.leftRect.translate(this.w/2,this.h/2)},enumerable:!1,configurable:!0}),t.prototype.div=function(t,e){return this.mul(1/t,1/e)},t.prototype.mul=function(e,i){return new t(Math.floor(this.x*e),Math.floor(this.y*i),Math.ceil(this.w*e),Math.ceil(this.h*i))},t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y,this.w+e.w,this.h+e.h)},t.prototype.intersect=function(t){return!(t.left>this.right||t.right<this.left||t.top>this.bottom||t.bottom<this.top)},t.prototype.lock=function(t){var e=Math.max(this.x,t.x),i=Math.max(this.y,t.y);return e=Math.min(e,t.right-this.w),i=Math.min(i,t.bottom-this.h),this.move(e,i)},t.prototype.approach=function(t,e,i){var n=t.sub(this.xy).scale(e);return n.length>i&&(n=n.normalize.scale(i)),this.translate(n.x,n.y)},t.prototype.move=function(e,i){return this.x===e&&this.y===i?this:new t(e,i,this.w,this.h)},t.prototype.translate=function(t,e){return this.move(this.x+t,this.y+e)},t.prototype.expand=function(e,i){return 0===i&&0===e?this:new t(this.x,this.y,this.w+e,this.h+i)},t.prototype.expandCentered=function(e,i){return 0===i&&0===e?this:new t(this.x-e/2,this.y-i/2,this.w+e,this.h+i)},t.prototype.expandM=function(t,e){return this.expandCentered(this.w*t-this.w,this.h*e-this.h)},t.prototype.equal=function(t){return this.x===t.x&&this.y===t.y&&this.w===t.w&&this.h===t.h},t.prototype.i=function(e,i){return new t(h(e,this.x,i.x),h(e,this.y,i.y),h(e,this.w,i.w),h(e,this.h,i.h))},t.zero=new t(0,0,0,0),t.fromPoints=function(e){return e.sort((function(t,e){return t.x-e.x==0?t.y-e.y:t.x-e.x})),e.reduce((function(e,i){return e===t.empty?t.make({x:i.x,y:i.y,w:1,h:1}):(e.x+e.w===i.x&&(e=e.expand(1,0)),e.y+e.h===i.y&&(e=e.expand(0,1)),e)}),t.empty)},t.fromKey=function(e){return t.make(function(t){var e=t.split(" ").map((function(t){return parseInt(t)}));return{x:e[0],y:e[1],w:e[2],h:e[3]}}(e))},t.empty=new t(0,0,0,0),t.make=function(e){return new t(e.x,e.y,e.w,e.h)},t.point=function(e){return t.fromPoints([e])},t}(),l=function(){function t(){this.data=new Map}return t.prototype.add=function(t,e){this.data.set(t.key,e)},t.prototype.checkPoint=function(t){return this.check(d.point(t))[0]},t.prototype.check=function(t){var e=[];return this.data.forEach((function(i,n){d.fromKey(n).intersect(t)&&e.push(i)})),e},t.prototype.checkAny=function(t){return this.check(t).length>0},t}(),y=function(){function t(t,e,i,n,r){this.dimExpand=u.make(1,1),this.collide=t,this.dim=e,this.hitbox=i,this.x=n,this.y=r}return Object.defineProperty(t.prototype,"sf",{get:function(){var t;return null===(t=this.sfi)||void 0===t?void 0:t[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"si",{get:function(){var t;return null===(t=this.sfi)||void 0===t?void 0:t[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"ahitbox",{get:function(){return this.hitbox.translate(this.x,this.y)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"adim",{get:function(){return this.dim.translate(this.x,this.y).expandM(this.dimExpand.x,this.dimExpand.y)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"grounded",{get:function(){this.y+=1;var t=this.collide(this.ahitbox);return this.y-=1,t},enumerable:!1,configurable:!0}),t.prototype.walled=function(t){this.x+=3*t;var e=this.collide(this.ahitbox);return this.x-=3*t,e},t.prototype.cliff=function(t){this.x+=t*this.hitbox.w/2;var e=this.grounded;return this.x-=t*this.hitbox.w/2,this.grounded&&!e},t.prototype.moveX=function(t){this.x+=t},t.prototype.moveY=function(t){this.y+=t},t.prototype.render=function(t){this.sf&&t.s(this.sf.x,this.sf.y,this.sf.w,this.sf.h,this.adim.x,this.adim.y,this.adim.w,this.adim.h)},t.prototype.debug=function(t){t.strokeStyle("green"),t.stroke(this.ahitbox.x,this.ahitbox.y,this.ahitbox.w,this.ahitbox.h)},t}(),m=function(){function t(t){this.remx=0,this.remy=0,this.dx=0,this.dy=0,this.entity=t}return Object.defineProperty(t.prototype,"sf",{get:function(){return this.entity.sf},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"grounded",{get:function(){return this.entity.grounded},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"wallGrounded",{get:function(){return this.walled(1)||this.walled(-1)},enumerable:!1,configurable:!0}),t.prototype.walled=function(t){return this.entity.walled(t)},Object.defineProperty(t.prototype,"collide",{get:function(){return this.entity.collide},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"facing",{get:function(){return Math.sign(this.dx)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"facingLeft",{get:function(){return-1===this.facing},enumerable:!1,configurable:!0}),t.prototype.move=function(){this.remx+=this.dx;var t=Math.floor(this.remx);this.remx-=t,this.moveX(t),this.remy+=this.dy;var e=Math.floor(this.remy);this.remy-=e,this.moveY(e)},t.prototype.moveX=function(t){for(var e=Math.sign(t),i=0;i<Math.abs(t);i++)if(this.entity.moveX(e),this.collide(this.entity.ahitbox))return this.dx=0,void this.entity.moveX(-1*e)},t.prototype.moveY=function(t){for(var e=Math.sign(t),i=0;i<Math.abs(t);i++)if(this.entity.moveY(e),this.collide(this.entity.ahitbox))return this.dy=0,void this.entity.moveY(-1*e)},t.prototype.render=function(t){this.entity.sf&&this.entity.si&&t.s(this.entity.sf.x+this.entity.si.x*this.entity.sf.w,this.entity.sf.y+this.entity.si.y*this.entity.sf.h,this.entity.sf.w,this.entity.sf.h,this.entity.adim.x,this.entity.adim.y,this.entity.adim.w,this.entity.adim.h,this.facingLeft)},t}();var b,g=30,S=(b=function(t,e){return(b=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}b(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});const x=function(t){function e(e,i){var n=t.call(this,e)||this;return n.dynamic=i,n}return S(e,t),Object.defineProperty(e.prototype,"dx",{get:function(){return this.dynamic.dx},set:function(t){this.dynamic.dx=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"dy",{get:function(){return this.dynamic.dy},set:function(t){this.dynamic.dy=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"entity",{get:function(){return this.dynamic.entity},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ahitbox",{get:function(){return this.entity.ahitbox},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"grounded",{get:function(){return this.entity.grounded},enumerable:!1,configurable:!0}),e.prototype.update=function(){this.dynamic.move()},e}(c),w={linear:function(t){return t},easeInQuad:function(t){return t*t},easeOutQuad:function(t){return t*(2-t)},easeInOutQuad:function(t){return t<.5?2*t*t:(4-2*t)*t-1},easeInCubic:function(t){return t*t*t},easeOutCubic:function(t){return--t*t*t+1},easeInOutCubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},easeInQuart:function(t){return t*t*t*t},easeOutQuart:function(t){return 1- --t*t*t*t},easeInOutQuart:function(t){return t<.5?8*t*t*t*t:1-8*--t*t*t*t},easeInQuint:function(t){return t*t*t*t*t},easeOutQuint:function(t){return 1+--t*t*t*t*t},easeInOutQuint:function(t){return t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t}},v=function(){function t(t,e,i){this.i=-1,this.ticks=e,this.hooks=t,this.easing=i||w.linear}return Object.defineProperty(t.prototype,"safeTicks",{get:function(){return this.ticks||1},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"on",{get:function(){return this.i>=0},enumerable:!1,configurable:!0}),t.prototype.begin=function(t){var e,i;this.ticks=t||this.ticks,this.i=0,null===(i=(e=this.hooks).begin)||void 0===i||i.call(e)},t.prototype.cut=function(t){this.i>=0&&(null==t||t(),this.end())},t.prototype.end=function(){var t,e;this.i=-1,null===(e=(t=this.hooks).end)||void 0===e||e.call(t)},t.prototype.update=function(){var t,e;if(this.i>=0){this.i++;var i=this.i/(this.ticks||1);null===(e=(t=this.hooks).update)||void 0===e||e.call(t,this.easing(i),this.ticks||this.i),this.ticks&&this.i>=this.ticks&&this.end()}},t}(),k=function(){function t(t,e){for(var i in this.states=new Map,t)this.states.set(i,this.makeState(t[i]));this.current=e,this.maybeState(this.current,(function(t){return t.begin()}))}return t.prototype.maybeState=function(t,e){var i=this.states.get(t);if(i)return e(i);console.warn("no state ",t)},t.prototype.makeState=function(t){var e=t.hooks;return new v({begin:this.makeBegin(e.begin),update:this.makeUpdate(e.update),end:this.makeEnd(e.end,t.next)},t.ticks,t.easing)},t.prototype.makeBegin=function(t){return function(){null==t||t()}},t.prototype.makeUpdate=function(t){return function(e,i){null==t||t(e,i)}},t.prototype.makeEnd=function(t,e){var i=this;return function(){null==t||t(),e&&i.transition(e)}},t.prototype.transition=function(t){this.maybeState(this.current,(function(t){t.cut()})),this.current=t,this.maybeState(this.current,(function(t){t.begin()}))},t.prototype.update=function(){this.maybeState(this.current,(function(t){t.update()}))},t}(),O=function(){function t(t){t&&(this.sf=t)}return Object.defineProperty(t.prototype,"sf",{set:function(t){this.sfi?this.sfi[0]=t:this.sfi=[t,u.zero]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"si",{set:function(t){var e=u.make(Math.floor(3*t),0);this.sfi&&(this.sfi[1]=e)},enumerable:!1,configurable:!0}),t}();var j=function(){return(j=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)},P={w:13,h:18},R={rest:j({x:0,y:0},P),turn:j({x:0,y:18},P),pace:j({x:0,y:36},P),stick:j({x:0,y:54},P),wlift:j({x:0,y:72},P),dash:j({x:0,y:90},P),jump:j({x:0,y:108},P)};const A=function(){function t(t,e){this.psfi=new O,this.gravityTicks=15,this.dynamic=t,this.maxHeight=e,this.machine=new k({liftAccel:{hooks:{begin:this.liftAccelBegin.bind(this),update:this.liftAccelUpdate.bind(this)},next:"liftDeccel",ticks:1},liftDeccel:{hooks:{update:this.liftDeccelUpdate.bind(this)},next:"liftHang",ticks:g},liftHang:{hooks:{begin:this.liftHangBegin.bind(this)},next:"landAccel",ticks:5},landAccel:{hooks:{begin:this.landAccelBegin.bind(this),update:this.landAccelUpdate.bind(this)},next:"gravity",ticks:1},rest:{hooks:{begin:this.restBegin.bind(this),update:this.restUpdate.bind(this)}},coyote:{hooks:{},ticks:5,next:"gravity"},gravity:{hooks:{begin:this.gravityBegin.bind(this),update:this.gravityUpdate.bind(this)}}},"rest")}return Object.defineProperty(t.prototype,"sfi",{get:function(){return this.psfi.sfi},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vMax",{get:function(){var t=this.machine.maybeState("liftAccel",(function(t){return t.safeTicks})),e=this.machine.maybeState("liftDeccel",(function(t){return t.safeTicks}));return 2*this.maxHeight/(t+e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"landVMax",{get:function(){var t=this.machine.maybeState("landAccel",(function(t){return t.safeTicks}));return 2*this.maxHeight/t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fallVMax",{get:function(){return this.maxHeight/this.gravityTicks},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"groundedGrace",{get:function(){return this.dynamic.grounded},enumerable:!1,configurable:!0}),t.prototype.request=function(){"rest"!==this.machine.current&&"coyote"!==this.machine.current||this.machine.transition("liftAccel")},t.prototype.cutRequest=function(){"liftAccel"!==this.machine.current&&"liftDeccel"!==this.machine.current||this.machine.transition("landAccel")},t.prototype.gravityUpdate=function(t){if(this.dynamic.grounded)this.machine.transition("rest");else{var e=Math.min(t,this.gravityTicks)/this.gravityTicks;this.dynamic.dy=w.easeOutCubic(e)*this.fallVMax,this.dynamic.entity.dimExpand=this.dynamic.entity.dimExpand.ipol(t%60/60,u.one)}},t.prototype.restUpdate=function(t){this.dynamic.grounded||this.machine.transition("coyote")},t.prototype.liftAccelBegin=function(){this.psfi.sf=d.make(R.jump)},t.prototype.landAccelBegin=function(){},t.prototype.gravityBegin=function(){},t.prototype.restBegin=function(){this.dynamic.dy=0,this.psfi.sfi=void 0,this.dynamic.entity.dimExpand=u.one},t.prototype.liftHangBegin=function(){this.dynamic.dy=0},t.prototype.liftDeccelUpdate=function(e){this.dynamic.dy=(e-1)*this.vMax,this.dynamic.entity.dimExpand=u.one.ipol(Math.min(1,e+.5),t.liftDimExpand)},t.prototype.liftAccelUpdate=function(t){this.dynamic.dy=-t*this.vMax},t.prototype.landAccelUpdate=function(t){this.dynamic.grounded&&this.machine.transition("rest"),this.dynamic.dy=0},t.prototype.update=function(){this.machine.update()},t.liftDimExpand=u.make(.6,1.4),t}(),M=function(){function t(t){var e=this;this.Accel=new v({begin:this.accelBegin.bind(this),update:this.onAccel.bind(this),end:function(){return e.Pace.begin()}},20),this.Pace=new v({begin:this.paceBegin.bind(this),update:this.onPace.bind(this)}),this.Rest=new v({begin:this.restBegin.bind(this)}),this.maxAccelX=16,this.direction=t,this.dx=0,this.Rest.begin()}return Object.defineProperty(t.prototype,"sf",{set:function(t){this.sfi?this.sfi[0]=t:this.sfi=[t,u.zero]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"si",{set:function(t){var e=u.make(Math.floor(3*t),0);this.sfi&&(this.sfi[1]=e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"vMax",{get:function(){return 2*this.maxAccelX/this.Accel.safeTicks},enumerable:!1,configurable:!0}),t.prototype.request=function(){var t=this;this.Rest.cut((function(){t.Accel.begin()}))},t.prototype.cool=function(){var t=this;this.Accel.cut((function(){t.Rest.begin()})),this.Pace.cut((function(){t.Rest.begin()}))},t.prototype.accelBegin=function(){this.sf=d.make(R.turn)},t.prototype.paceBegin=function(){this.sf=d.make(R.pace)},t.prototype.restBegin=function(){this.dx=0,this.sfi=void 0},t.prototype.onAccel=function(t){this.dx=t*this.direction*this.vMax,this.si=t},t.prototype.onPace=function(t){this.dx=this.direction*this.vMax,this.si=t%g/g},t.prototype.update=function(){this.Accel.update(),this.Pace.update(),this.Rest.update()},t}(),U=function(){function t(t,e,i){this.psfi=new O,this.maxFall=i,this.dynamic=t,this.direction=e,this.machine=new k({liftAccelXY:{hooks:{begin:this.liftAccelBegin.bind(this),end:this.liftAccelEnd.bind(this),update:this.liftAccelXYUpdate.bind(this)},ticks:20,next:"liftAccelY"},liftAccelY:{hooks:{update:this.liftAccelYUpdate.bind(this)},ticks:10,next:"rest"},stick:{hooks:{end:this.stickEnd.bind(this),begin:this.stickBegin.bind(this),update:this.stickUpdate.bind(this)}},stickLift:{hooks:{begin:this.stickBegin.bind(this),end:this.stickEnd.bind(this),update:this.stickLiftUpdate.bind(this)}},quickStickThenRest:{hooks:{begin:this.stickBegin.bind(this),end:this.stickEnd.bind(this),update:this.quickStickThenRestUpdate.bind(this)},ticks:g,next:"rest"},rest:{hooks:{update:this.restUpdate.bind(this)}},nowall:{hooks:{update:this.nowallUpdate.bind(this)}}},"nowall")}return Object.defineProperty(t.prototype,"sfi",{get:function(){return this.psfi.sfi},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"liftVMax",{get:function(){return 32/this.machine.maybeState("liftAccelXY",(function(t){return t.safeTicks}))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"stickVMax",{get:function(){return this.maxFall/g},enumerable:!1,configurable:!0}),t.prototype.upRequest=function(){["rest","stickLift","stick","quickStickThenRest"].includes(this.machine.current)&&this.dynamic.walled(this.direction)&&(this.dynamic.grounded||this.machine.transition("liftAccelXY"))},t.prototype.request=function(){"rest"===this.machine.current&&this.dynamic.walled(this.direction)&&(this.dynamic.grounded||this.machine.transition("stickLift"))},t.prototype.cool=function(){"stick"!==this.machine.current&&"stickLift"!==this.machine.current||this.machine.transition("rest")},t.prototype.stickBegin=function(){this.psfi.sf=d.make(R.stick)},t.prototype.stickEnd=function(){this.psfi.sfi=void 0},t.prototype.liftAccelBegin=function(){this.psfi.sf=d.make(R.wlift)},t.prototype.liftAccelEnd=function(){this.psfi.sfi=void 0},t.prototype.liftAccelXYUpdate=function(t){this.dynamic.dx=t*this.direction*-1*this.liftVMax*.8,this.dynamic.dy=-t*this.liftVMax},t.prototype.liftAccelYUpdate=function(t){this.dynamic.dy=(t-1)*this.liftVMax},t.prototype.stickLiftUpdate=function(t){this.dynamic.dy<=0?this.dynamic.dy*=1.1:this.machine.transition("stick")},t.prototype.stickUpdate=function(){this.dynamic.walled(this.direction)||this.machine.transition("nowall"),this.dynamic.dy=this.stickVMax},t.prototype.quickStickThenRestUpdate=function(){this.dynamic.dy<=0?this.dynamic.dy*=1.1:this.dynamic.dy=this.stickVMax},t.prototype.nowallUpdate=function(){this.dynamic.walled(this.direction)&&this.machine.transition("quickStickThenRest")},t.prototype.restUpdate=function(){this.dynamic.walled(this.direction)||this.machine.transition("nowall")},t.prototype.update=function(){this.machine.update()},t}(),L=function(){function t(t){this.psfi=new O,this.maxDJump=1,this.dJump=this.maxDJump,this.dynamic=t,this.xDirection=0,this.yDirection=0,this.machine=new k({dashInput:{hooks:{update:this.dashInputUpdate.bind(this)},next:"dash",ticks:5},dash:{hooks:{begin:this.dashBegin.bind(this),update:this.dashUpdate.bind(this)},next:"dashCool",ticks:20,easing:w.easeInOutQuad},dashCool:{hooks:{update:this.dashCoolUpdate.bind(this)},next:"rest",ticks:20},rest:{hooks:{begin:this.restBegin.bind(this),update:this.restUpdate.bind(this)}}},"rest")}return Object.defineProperty(t.prototype,"sfi",{get:function(){return this.psfi.sfi},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"maxDashV",{get:function(){var e=this.machine.maybeState("dash",(function(t){return t.safeTicks}));return 2*t.distance/e},enumerable:!1,configurable:!0}),t.prototype.xRequest=function(t){"dashInput"===this.machine.current&&(this.xDirection=t)},t.prototype.yRequest=function(t){"dashInput"===this.machine.current&&(this.yDirection=t)},t.prototype.request=function(){"rest"===this.machine.current&&this.dJump>0&&this.machine.transition("dashInput")},t.prototype.restBegin=function(){this.xDirection=0,this.yDirection=0,this.psfi.sfi=void 0},t.prototype.restUpdate=function(){(this.dynamic.grounded||this.dynamic.wallGrounded)&&(this.dJump=this.maxDJump)},t.prototype.dashBegin=function(){this.dJump--,this.psfi.sf=d.make(R.dash)},t.prototype.dashInputUpdate=function(t){this.dynamic.dx=(1-t)*this.xDirection,this.dynamic.dy=(1-t)*this.yDirection},t.prototype.dashUpdate=function(t){this.dynamic.dx=t*this.xDirection*this.maxDashV*.5,this.dynamic.dy=t*this.yDirection*this.maxDashV*.5},t.prototype.dashCoolUpdate=function(t){this.dynamic.dx=(1-t)*this.xDirection*this.maxDashV*.5,this.dynamic.dy=(1-t)*this.yDirection*this.maxDashV*.5},t.prototype.update=function(){this.machine.update()},t.distance=64,t}();var T=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();const _=function(t){function e(e,i){var n=t.call(this,e,new m(i))||this;return n.pause=!1,n.restI=0,n.psfi=new O(d.make(R.rest)),n.runLeft=new M(-1),n.runRight=new M(1),n.jump=new A(n.dynamic,32),n.slideRight=new U(n.dynamic,1,6.4),n.slideLeft=new U(n.dynamic,-1,6.4),n.dash=new L(n.dynamic),n}return T(e,t),Object.defineProperty(e.prototype,"target",{get:function(){return this.entity.ahitbox.xy.sub(f)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"origin",{get:function(){return this.entity.ahitbox.origin},enumerable:!1,configurable:!0}),e.prototype.update=function(){var e=this.input.btn(r.Left),i=this.input.btn(r.Right),n=this.input.btn(r.Up),o=this.input.btn(r.Down),s=this.input.btn(r.X),a=this.input.btn(r.C);e>0?(this.dash.xRequest(-1),this.slideLeft.request(),this.runLeft.request(),s>0&&this.slideRight.upRequest()):e<0&&(this.slideLeft.cool(),this.runLeft.cool()),i>0?(this.dash.xRequest(1),this.slideRight.request(),this.runRight.request(),s>0&&this.slideLeft.upRequest()):i<0&&(this.slideRight.cool(),this.runRight.cool()),s>0?(s<10&&(this.slideLeft.upRequest(),this.slideRight.upRequest()),s<60&&this.jump.request()):s<0||0===s&&this.jump.cutRequest(),a>0&&a<60&&this.dash.request(),n>0&&this.dash.yRequest(-1),o>0&&this.dash.yRequest(1),this.psfi.si=this.restI++%g/g,this.entity.sfi=this.dash.sfi||this.slideLeft.sfi||this.slideRight.sfi||this.jump.sfi||this.runLeft.sfi||this.runRight.sfi||this.psfi.sfi,this.dynamic.dx=this.runLeft.dx+this.runRight.dx,this.jump.update(),this.runLeft.update(),this.runRight.update(),this.slideRight.update(),this.slideLeft.update(),this.dash.update(),this.pause||t.prototype.update.call(this)},e.prototype.render=function(){this.dynamic.render(this.draw)},e.maker={hitbox:d.make({x:0,y:-5,w:8,h:12}),dim:d.make({x:-3,y:-10,w:13,h:18}),char:"@",apply:function(t,i,n,r){return new e(t,new y(i,this.dim,this.hitbox,n,r))}},e}(x),D=function(){function t(){this.segments=[]}return Object.defineProperty(t.prototype,"w",{get:function(){return this.segments.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"h",{get:function(){return this.segments.reduce((function(t,e){return Math.max(t,e.length)}),0)},enumerable:!1,configurable:!0}),t.prototype.get=function(t,e,i){return void 0!==i?(this.segments[t]||(this.segments[t]=[]),this.segments[t][e]=i,i):this.segments[t]?this.segments[t][e]:void 0},t}(),B=function(){function t(t,e){this.cellW=t,this.cellH=e,this.data=new D}return Object.defineProperty(t.prototype,"w",{get:function(){return this.data.w*this.cellW},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"h",{get:function(){return this.data.h*this.cellH},enumerable:!1,configurable:!0}),t.prototype.get=function(t,e,i){return this.data.get(t,e,i)},t.prototype.collide=function(t){var e=Math.floor(t.left/this.cellW),i=Math.floor(t.top/this.cellH),n=Math.floor(t.right/this.cellW),r=Math.floor(t.bottom/this.cellH);return this.checkRect(e,i,n,r)},t.prototype.checkRect=function(t,e,i,n){for(var r=t;r<=i;r++)for(var o=e;o<=n;o++)if(this.data.get(r,o))return!0;return!1},t.prototype.render=function(t){t.strokeStyle("red");for(var e=0;e<this.data.w;e++)for(var i=0;i<this.data.h;i++)this.data.get(e,i)&&t.stroke(e*this.cellW,i*this.cellH,this.cellW,this.cellH)},t}();var q=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();const E=function(t){function e(e){var i=t.call(this,e)||this;return i.grid=new B(8,8),i.checkpoints=[],i}return q(e,t),e.prototype.load=function(t){var e,i=this,n=(e=t,function(t){var i=[];return e.split("\n").forEach((function(e,n){for(var r=0;r<e.length;r++)e[r]&&e[r]===t&&i.push(u.make(r,n))})),i});n("S").forEach((function(t){i.grid.get(t.i,t.j,!0)})),n("@").forEach((function(t){i.checkpoints.push(t.mul(p))}))},e.prototype.update=function(){},e.prototype.render=function(){this.grid.render(this.draw)},e}(c),C=function(){function t(){this.iWillLock=0,this.frustum=d.make({x:0,y:0,w:320,h:160})}return Object.defineProperty(t.prototype,"lockedFrustum",{get:function(){if(this.lock){if(this.willLock){var t=this.frustum.lock(this.lock),e=this.frustum.lock(this.willLock);return t.i(this.iWillLock,e)}return this.frustum.lock(this.lock)}return this.frustum},enumerable:!1,configurable:!0}),t.prototype.endLock=function(){this.iWillLock=0,this.lock=this.willLock,this.willLock=void 0},t.prototype.worldCameraOffset=function(t,e){return u.make(t,e).sub(this.frustum.xy)},t.prototype.update=function(){this.target&&(this.frustum=this.frustum.approach(this.target,.2,2)),this.frustum=this.lockedFrustum},t}(),X=function(){function t(t,e,i){this.camera=t,this.machine=new k({rest:{hooks:{begin:this.restBegin.bind(this)}},transition:{hooks:{begin:e,update:this.transitionUpdate.bind(this),end:i},ticks:20,next:"rest"}},"rest")}return t.prototype.request=function(t){"rest"===this.machine.current&&(this.camera.willLock=t,this.machine.transition("transition"))},t.prototype.restBegin=function(){this.camera.endLock()},t.prototype.transitionUpdate=function(t){this.camera.iWillLock=t},t.prototype.update=function(){this.machine.update()},t}();var G=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();const I=function(t){function e(e){var i=t.call(this,e)||this;return i.camera=new C,i.dquad=new l,i.rev=new Map,i.transition=new X(i.camera,i.onTransitionBegin.bind(i),i.onTransitionEnd.bind(i)),i}return G(e,t),Object.defineProperty(e.prototype,"visible",{get:function(){var t=this.camera.frustum;return this.dquad.check(t)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"activeRect",{get:function(){return this.rev.get(this.activeRoom)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"playerTransitionRoom",{get:function(){return this.dquad.checkPoint(this.playerOrigin)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"willTransitionToRoom",{get:function(){var t=this.playerTransitionRoom;if(t!==this.activeRoom)return t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"playerTarget",{get:function(){return this.activeRect.translate(this.player.target.x,this.player.target.y).xy},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"playerOrigin",{get:function(){return this.activeRect.translate(this.player.origin.x,this.player.origin.y).xy},enumerable:!1,configurable:!0}),e.prototype.onTransitionBegin=function(){this.player.pause=!0},e.prototype.onTransitionEnd=function(){if(this.willTransitionToRoom){this.player.pause=!1;var t=this.activeRect;this.activeRoom=this.willTransitionToRoom;var e=this.activeRect,i=t.xy.sub(e.xy);this.player.entity.moveX(i.x),this.player.entity.moveY(i.y)}},e.prototype.load=function(t,e){var i=this;(function(t,e){var i={};t.split("\n").forEach((function(t,n){for(var r=0;r<t.length;r++)t[r]&&e[t[r]]&&(i[t[r]]||(i[t[r]]=[]),i[t[r]].push(u.make(r,n)))}));var n=[];for(var r in i){var o=e[r],s=d.fromPoints(i[r]);n.push([o,s])}return n})(t,e).map((function(t){var e=t[0],n=t[1].mul(160,80),r=new E(i.context);r.load(e),i.dquad.add(n,r),i.rev.set(r,n),i.activeRoom=r}));var n=this.activeRoom.checkpoints[0];this.player=_.maker.apply(this.context,(function(t){return i.activeRoom.grid.collide(t)||!i.playerTransitionRoom}),n.x,n.y),this.camera.lock=this.activeRect},e.prototype.update=function(){this.camera.update(),this.player.update(),this.transition.update(),this.camera.target=this.playerTarget;var t=this.willTransitionToRoom;t&&this.transition.request(this.rev.get(t))},e.prototype.worldCameraOffset=function(t,e){var i=this.camera.worldCameraOffset(t,e);this.draw.camera(i.x,i.y)},e.prototype.render=function(){var t=this;this.visible.forEach((function(e){var i=t.rev.get(e);t.worldCameraOffset(i.x,i.y),e.render()})),this.worldCameraOffset(this.activeRect.x,this.activeRect.y),this.player.render()},e}(c);var F="\n\n\n\n\n                 S  S\n                 S  S\n                 S  S\n                 S  S\n                 S  S\n                 S  S\n                 S  S\n                 S  S     S\n                 S  S     S\n        SSSS     S  S     S\n                 S  S     SSS\nSSSSS            S  S     S            S\nS     SSSS                S            S\nS             S      @    S            S\nSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS",V={F:"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n        @                                               SSSSSSS\n     SSSSSSSSSSSSSSSSSS                   SSSSS         SSSSSSS\nSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS     SSSSSS         SSSSSSS\n",B:"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS",T:F,Q:F},Y=function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();const H=function(t){function e(e){var i=t.call(this,e)||this;return i.rooms=new I(e),i.rooms.load("\n        \nBBFFFF\nBBFFFF\n\n",V),i}return Y(e,t),e.prototype.update=function(){this.draw.camera(),this.draw.cls(),this.rooms.update()},e.prototype.render=function(){this.rooms.render()},e}(c);function W(i){var n;(n=t,new Promise((function(t){var e=new Image;e.src=n,e.onload=function(){return t(e)}}))).then((function(t){var n=new a(i),r=new e(n.ctx,t),o=new s;o.bind(),o.bindGamepad();var c,h=new H({draw:r,input:o});c=function(){h.update(),o.update(),h.render()},Date.now(),function t(){Date.now(),c(),requestAnimationFrame(t)}()}))}})(),kcapeW=n})();